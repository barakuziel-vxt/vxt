WITH ScoredAttributes AS (
    SELECT
        hv.HealthVitalsId,
        ev.eventId AS EventCode,
        ev.minCumulatedScore,
        ev.maxCumulatedScore,
        SUM(etas.Score) AS AttributeScore,
        c.customerName,
        et.entityTypeName,
        e.entityFirstName AS PatientName,
        e.entityId,
        hv.Timestamp,
        hv.StartTime,
        hv.EndTime,
        hv.AvgHR,
        hv.MaxHR,
        hv.MinHR,
        hv.RestingHR,
        hv.HRV_RMSSD,
        hv.Systolic,
        hv.Diastolic,
        hv.OxygenSat,
        hv.AvgGlucose,
        hv.BreathsPerMin,
        hv.BodyTemp,
        hv.ECGClassification,
        hv.AfibResult,
        hv.DeviceName,
        hv.LoadedAt
    FROM dbo.HealthVitals hv
    JOIN dbo.CustomerSubscriptions cs ON hv.userId = cs.entityId
    JOIN dbo.Event ev ON ev.eventId = cs.eventId
    JOIN dbo.EventCriteria ec ON ev.eventId = ec.eventId
    JOIN dbo.EntityTypeAttribute eta ON eta.entityTypeAttributeId = ec.entityTypeAttributeId
    JOIN dbo.EntityTypeAttributeScore etas ON etas.entityTypeAttributeId = eta.entityTypeAttributeId
    JOIN dbo.Entity e ON cs.entityId = e.entityId
    JOIN dbo.Customers c ON c.customerId = cs.customerId
    JOIN dbo.EntityType et ON e.entityTypeCode = et.entityTypeCode
    WHERE e.entityId = '033114869'
        AND hv.HealthVitalsId = 11487
        AND cs.subscriptionStartDate <= GETDATE()
        AND (cs.subscriptionEndDate IS NULL OR cs.subscriptionEndDate > GETDATE())
        AND CAST(CASE 
            WHEN eta.entityTypeAttributeCode = 'AvgHR' THEN CAST(hv.AvgHR AS VARCHAR(10))
            WHEN eta.entityTypeAttributeCode = 'MaxHR' THEN CAST(hv.MaxHR AS VARCHAR(10))
            WHEN eta.entityTypeAttributeCode = 'MinHR' THEN CAST(hv.MinHR AS VARCHAR(10))
            WHEN eta.entityTypeAttributeCode = 'Systolic' THEN CAST(hv.Systolic AS VARCHAR(10))
            WHEN eta.entityTypeAttributeCode = 'Diastolic' THEN CAST(hv.Diastolic AS VARCHAR(10))
            WHEN eta.entityTypeAttributeCode = 'BodyTemp' THEN CAST(hv.BodyTemp AS VARCHAR(10))
            WHEN eta.entityTypeAttributeCode = 'OxygenSat' THEN CAST(hv.OxygenSat AS VARCHAR(10))
            WHEN eta.entityTypeAttributeCode = 'AvgGlucose' THEN CAST(hv.AvgGlucose AS VARCHAR(10))
            WHEN eta.entityTypeAttributeCode = 'BreathsPerMin' THEN CAST(hv.BreathsPerMin AS VARCHAR(10))
            ELSE '0'
        END AS DECIMAL(10,2)) BETWEEN etas.MinValue AND etas.MaxValue
    GROUP BY hv.HealthVitalsId, ev.eventId, ev.minCumulatedScore,ev.maxCumulatedScore,c.customerName, et.entityTypeName,
             e.entityFirstName, e.entityId, hv.Timestamp, hv.StartTime, hv.EndTime, hv.AvgHR, hv.MaxHR, hv.MinHR,
             hv.RestingHR, hv.HRV_RMSSD, hv.Systolic, hv.Diastolic, hv.OxygenSat, hv.AvgGlucose, hv.BreathsPerMin,
             hv.BodyTemp, hv.ECGClassification, hv.AfibResult, hv.DeviceName, hv.LoadedAt
),
CumulativeScores AS (
    SELECT
        HealthVitalsId,
        EventCode,
        customerName,
        SUM(AttributeScore) AS TotalCumulativeScore,
        minCumulatedScore,
        maxCumulatedScore
    FROM ScoredAttributes
    GROUP BY HealthVitalsId, EventCode, customerName,minCumulatedScore,maxCumulatedScore
)
SELECT
    sa.HealthVitalsId,
    sa.EventCode,
    cs.TotalCumulativeScore,
    sa.customerName,
    sa.entityTypeName,
    sa.entityFirstName AS PatientName,
    sa.entityId,
    sa.Timestamp,
    sa.StartTime,
    sa.EndTime,
    sa.AvgHR,
    sa.MaxHR,
    sa.MinHR,
    sa.RestingHR,
    sa.HRV_RMSSD,
    sa.Systolic,
    sa.Diastolic,
    sa.OxygenSat,
    sa.AvgGlucose,
    sa.BreathsPerMin,
    sa.BodyTemp,
    sa.ECGClassification,
    sa.AfibResult,
    sa.DeviceName,
    sa.LoadedAt
FROM ScoredAttributes sa
JOIN CumulativeScores cs ON sa.HealthVitalsId = cs.HealthVitalsId 
    AND sa.EventCode = cs.EventCode
    AND sa.customerName = cs.customerName
    -- WHERE cs.TotalCumulativeScore BETWEEN cs.minCumulatedScore AND cs.maxCumulatedScore 
ORDER BY sa.HealthVitalsId, sa.EventCode DESC;